<!DOCTYPE html>
<html>
  <head>
    {% load static %}
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="{% static 'css/monaco/editor.main.css' %}">
  </head>

  <body>
    <h2>Monaco Editor YAML test page</h2>
    <code id="path"></code>
    <div id="container" style="width:800px;height:600px;border:1px solid grey">
    </div>

    <style>
      .x-highlight-range {
        background-color: lightblue;
      }
    </style>

    <script>
      // Loading basic-languages to get the YAML language definition
      var paths = {
        'vs/basic-languages': '/static/js/monaco-lang',
        'vs/language/yaml': '/static/js/monaco-yaml',
        vs: '/static/js/vs',
        // prettier: '/static/js/prettier',
      };
      var require = {
        paths: paths,
      };
    </script>
    <script src="{% static 'js/monaco/loader.js' %}"></script>
    <script src="{% static 'js/monaco/editor.main.nls.js' %}"></script>
    <script src="{% static 'js/monaco/editor.main.js' %}"></script>

    {{ JSON|json_script:"def-data" }}
    <script>
      require([
        'vs/basic-languages/monaco.contribution',
        'vs/language/yaml/monaco.contribution',
        // 'prettier/standalone',
        // 'prettier/parser-yaml',
      ], function() {
        const yaml = `apiVersion: `;
        const modelUri = monaco.Uri.parse('a://b/foo.json');
        const editor = monaco.editor.create(
          document.getElementById('container'),
          {
            language: 'yaml',
            showFoldingControls: 'always',
            model: monaco.editor.createModel(yaml, 'yaml', modelUri),
          }
        );
        editor.getModel().updateOptions({tabSize: 2});

        var myschema = JSON.parse(document.getElementById('def-data').textContent);

        monaco.languages.yaml.yamlDefaults.setDiagnosticsOptions({
          enableSchemaRequest: true,
          // hover: true,
          completion: true,
          validate: true,
          isKubernetes: true,
          tabSize: 2,
          // format: true,
          schemas: [
            {
              uri: 'http://myserver/foo-schema.json', // id of the first schema
              fileMatch: [modelUri.toString()], // associate with our model
              schema: myschema,
            },
         ],
        });

        /*
        require(['vs/editor/contrib/quickOpen/quickOpen'], async quickOpen => {
          const NEVER_CANCEL_TOKEN = {
            isCancellationRequested: false,
            onCancellationRequested: () => Event.NONE,
          };

          let oldDecorations = [];

          async function _getSymbolForPosition(model, position) {
            const symbols = await quickOpen.getDocumentSymbols(
              model,
              false,
              NEVER_CANCEL_TOKEN
            );

            function _recur(symbol) {
              let target = symbol;
              if (symbol && symbol.children && symbol.children.length) {
                target =
                  _recur(
                    symbol.children.find(child =>
                      child.range.containsPosition(position)
                    )
                  ) || symbol;
              }

              return target;
            }

            return _recur({ children: symbols });
          }

          editor.onDidChangeCursorSelection(async ({ selection }) => {
            const model = editor.getModel();
            const position = selection.getPosition();
            const symbol = await _getSymbolForPosition(model, position);

            // console.log(`${symbol.name}: ${symbol.range}`);
            if (symbol && symbol.range) {
              const decoration = {
                range: symbol.range,
                options: {
                  isWholeLine: false,
                  className: 'x-highlight-range',
                },
              };

              oldDecorations = editor.deltaDecorations(
                oldDecorations,
                decoration ? [decoration] : []
              );
            }
          });
        }); */
      });
    </script>
  </body>
</html>
