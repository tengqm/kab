{% extends "base.html" %}

{% load core_tags %}
{% load static %}

{% block title %}
  <title>Definition: {{ API }} - </title>
  <link rel="stylesheet" href="{% static 'css/jstree-3.2.1.min.css' %}">
  <style>
    P {line-height: 1.2; }
  </style>
{% endblock %}

{% block main_content %}

  <div class="btn-toolbar pb-3 bg-light" role="toolbar" aria-label="Definition Toolbar"
      style="border-bottom-color:gray; border-bottom-style:solid; border-bottom-width: 1px;">
    <button class="btn btn-outline-primary mr-2" type="button" href="#" data-toggle="collapse"
        data-target="#schema_tree" aria-controls="schema_tree" aria-expanded="false"
        aria-label="Toggle navigation">
       <i class="fa faw fa-bars"></i>
    </button>

    <!-- Switch to -->
    <div class="btn-group mr-2" role="group">
      <button id="btnSwitchTo" type="button" class="btn btn-outline-secondary dropdown-toggle"
          data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Switch To
      </button>
      <div class="dropdown-menu" aria-labelledby="btnSwitchTo">
        {% for AV, VLIST in VERSIONS.items %}
          {% for V in VLIST %}
            {% if V.group %}
              {% dereference AV V.group V.version NAME as LINK %}
            {% else %}
              {% dereference AV "*" "*" NAME as LINK %}
            {% endif %}
            <a class="dropdown-item" href="{{ LINK.0 }}">{{ AV }}: 
              {% if V.group %}
                {{ V.group }}/{{ V.version}}
              {% else %}
                */*
              {% endif %}
            </a>
          {% endfor %}
        {% empty %}
          <a class="dropdown-item disabled" href="#">No other version found!</a>
        {% endfor %}
      </div>
    </div>

    <!-- Compare -->
    <div class="btn-group mr-2" role="group">
      <button id="btnCompare" type="button" class="btn btn-outline-secondary dropdown-toggle"
          data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Compare
      </button>
      <div class="dropdown-menu" aria-labelledby="navCompare">
        {% for AV, VLIST in VERSIONS.items %}
          {% for V in VLIST %}
            {% if V.group %}
              {% dereference AV V.group V.version NAME as LINK %}
            {% else %}
              {% dereference AV "*" "*" NAME as LINK %}
            {% endif %}
            <a class="dropdown-item" href="#"
              {% if V.group %}
                onclick="compare('{{ AV }}', '{{ V.group }}', '{{ V.version}}')">
                {{ AV }}: {{ V.group }}/{{ V.version}}</a>
              {% else %}
                onclick="compare('{{ AV }}', '*', '*')">
                {{ AV }}: */*</a>
              {% endif %}
            </a>
          {% endfor %}
        {% empty %}
          <a class="dropdown-item disabled" href="#">No other version found!</a>
        {% endfor %}
      </div>
    </div>

    <!-- try -->
    <a class="btn btn-outline-info"
          href="{% url 'try-resource' API GROUP VERSION NAME %}">
      <i class="fa faw fa-code"></i>
    </a>
  </div>

  <div class="row">
    <div id="schema_tree" class="col-md-6 col-sm-8 col-lg-4 collapse"
        style="border-right-color:gray; border-right-style:solid; border-right-width: 1px; overflow-x: scroll;"></div>
    <div id="schema_data" class="col">
      {% include "core/definition.html" %}
    </div>
  </div>

{% endblock %}

{% block javascript %}
<!-- for jstree navigation -->
<script src="{% static 'js/jstree-3.2.1.min.js' %}"></script>
{{ JSON|json_script:"def-data" }}

<script>
  window.onresize = function(ev) {
    toggleExpandButtons();
  };

  function toggleExpandButtons() {
    var height = $("#appearsList").prop("scrollHeight");
    if (parseInt(height) > 35) {
      $("#btnExpandAppears").removeClass("d-none").addClass("d-unset");
    }
    else {
      $("#btnExpandAppears").removeClass("d-unset").addClass("d-none");
    }
    height = $("#versionList").prop("scrollHeight");
    if (parseInt(height) > 39) {
      $("#btnExpandVersions").removeClass("d-none").addClass("d-unset");
    }
    else {
      $("#btnExpandVersions").removeClass("d-unset").addClass("d-none");
    }
  }
  function compare(api, gn, gv) {
    $("#form_api").val(api);
    $("#form_group").val(gn);
    $("#form_version").val(gv);
    $("#form-compare").submit();
  }

  $(function () {
    toggleExpandButtons();
    var value = JSON.parse(document.getElementById('def-data').textContent);
    $('#schema_tree').jstree(
      {
        "core": {
          "data": value,
          "animation": 0,
          "check_callback": true,
        },
        "plugins": ["wholerow"]
      }
    );
  });

  $('#schema_tree').on("select_node.jstree", function (e, data) {
    var href = data.node.a_attr.href;
    if (href === '#')
      return '';

    location.href = "/apis/definition/" + href + "/";
  });
</script>
{% endblock %}
